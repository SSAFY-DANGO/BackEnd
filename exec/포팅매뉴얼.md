# 포팅매뉴얼

# 버전

| Back End | 버전 |
| --- | --- |
| Java | 17 (Zulu) |
| Spring Boot | 3.2.3 (Gradle) |
| Spring Security | 6 |
| MariaDB | 10.11.6 |
| JPA | 3.1.0 |
| IntelliJ | 2023.3.2 |
| Redis |  |

| Front End | 버전 |
| --- | --- |
| Node.js  | v20.10.0 |
| React  | 18.2.0 |
| yarn  | 1.22.21 |
| tailwindCSS  | 3.4.1 |
| react-redux | 9.1.0 |
| next.js  | 14.1.0 |
| eslint  | ^8 |

| IoT | 버전 |
| --- | --- |
| OS | Debian GNU/Linux 12 |
| Rapberry Pi | 4 Model B Rev 1.2 |
| Arduino | UNO R3 |
| Python | 3.11.2 |
| Kafka | 3.6.1 |

### package.json

```json
{
  "name": "dango-project",
  "private": true,
  "version": "0.0.0",
  "type": "module",
  "scripts": {
    "dev": "vite",
    "build": "vite build",
    "lint": "eslint . --ext js,jsx --report-unused-disable-directives --max-warnings 0",
    "preview": "vite preview"
  },
  "dependencies": {
    "autoprefixer": "^10.4.18",
    "axios": "^1.6.8",
    "postcss": "^8.4.36",
    "react": "^18.2.0",
    "react-dom": "^18.2.0",
    "react-icons": "^5.0.1",
    "react-router-dom": "^6.22.3",
    "recoil": "^0.7.7",
    "tailwindcss": "^3.4.1"
  },
  "devDependencies": {
    "@types/react": "^18.2.64",
    "@types/react-dom": "^18.2.21",
    "@vitejs/plugin-react": "^4.2.1",
    "eslint": "^8.57.0",
    "eslint-plugin-react": "^7.34.0",
    "eslint-plugin-react-hooks": "^4.6.0",
    "eslint-plugin-react-refresh": "^0.4.5",
    "vite": "^5.1.6"
  }
}

```

### build.gradle

```
plugins {
	id 'java'
	id 'org.springframework.boot' version '3.2.3'
	id 'io.spring.dependency-management' version '1.1.4'
	id 'org.asciidoctor.jvm.convert' version '3.3.2'
}

group = 'com.dango'
version = '0.0.1-SNAPSHOT'

java {
	sourceCompatibility = '17'
}

configurations {
	compileOnly {
		extendsFrom annotationProcessor
	}
}

repositories {
	mavenCentral()
}

ext {
	set('snippetsDir', file("build/generated-snippets"))
}

dependencies {
	implementation 'org.springframework.boot:spring-boot-starter-data-jpa'
	implementation 'org.springframework.boot:spring-boot-starter-security'
	implementation 'org.springframework.boot:spring-boot-starter-web'

	runtimeOnly 'org.mariadb.jdbc:mariadb-java-client'
	testImplementation 'org.springframework.boot:spring-boot-starter-test'
	testImplementation 'org.springframework.security:spring-security-test'

	// lombok
	implementation 'org.projectlombok:lombok:1.18.22'
	annotationProcessor 'org.projectlombok:lombok:1.18.22'
	annotationProcessor 'org.projectlombok:lombok-mapstruct-binding:0.2.0' // v1.18.16+ 부터

	// mapstruct
	implementation 'org.mapstruct:mapstruct:1.4.2.Final'
	annotationProcessor 'org.mapstruct:mapstruct-processor:1.4.2.Final'

	//validation
	implementation 'org.springframework.boot:spring-boot-starter-validation'

	//jwt
	implementation 'io.jsonwebtoken:jjwt-api:0.11.5'
	implementation 'io.jsonwebtoken:jjwt-impl:0.11.5'
	implementation 'io.jsonwebtoken:jjwt-jackson:0.11.5'

	//gson
	implementation 'com.google.code.gson:gson:2.9.1'

	//redis
	implementation 'org.springframework.boot:spring-boot-starter-data-redis'

	//swagger
	implementation 'org.springdoc:springdoc-openapi-starter-webmvc-ui:2.0.2'

	//kafka
	implementation 'org.springframework.kafka:spring-kafka'

	implementation 'io.hypersistence:hypersistence-utils-hibernate-63:3.7.3'

}

tasks.named('test') {
	outputs.dir snippetsDir
	useJUnitPlatform()
}

tasks.named('asciidoctor') {
	inputs.dir snippetsDir
	dependsOn test
}

```

# 환경변수

### .env

```
VITE_DANGO_URL_PROD=https://j10a702.p.ssafy.io
VITE_DANGO_URL_DEV=http://localhost:3000
VITE_DANGO_API_PROD=https://j10a702.p.ssafy.io/api/
VITE_DANGO_API_DEV=http://localhost:8081/api/
```

### application.yml

```yaml
spring:
  profiles:
    include: secret
  datasource:
    url: ${database.mariadb.dev.url}
    username: ${database.mariadb.dev.username}
    password: ${database.mariadb.dev.password}
    driver-class-name: org.mariadb.jdbc.Driver
  jpa:
    open-in-view: false
    generate-ddl: false
    show-sql: false
    properties:
      hibernate:
        dialect: org.hibernate.dialect.MariaDBDialect
  data:
    redis:
      host: ${database.redis.host}
      port: ${database.redis.port}
  kafka:
    consumer:
      bootstrap-servers: ${database.kafka.host}
      group-id: "consumer"

logging:
  level:
    org:
      springframework:
        security:
          DEBUG
jwt:
  secret: ${jwt.secret}

server:
  port: 8081

springdoc:
  api-docs:
    enabled: true
    version: openapi_3_0

  swagger-ui:
    path: /swagger-ui/index.html
    groups-order: DESC
    doc-expansion: none
    tags-sorter: alpha
    operationsSorter: method
    disable-swagger-default-url: true
    display-request-duration: true

```

# ERD

![ERD](/uploads/539ed15b3899d3891083a8d36765bb43/Untitled.png)

### jenkins script

FE

```jsx
pipeline {
    agent any

    stages {
        stage('clone') {
            steps {
                // 깃랩 fe-dev 가져오기
                echo 'git clone'
                git branch: 'dev', credentialsId: 'hyang', url: 'https://lab.ssafy.com/s10-bigdata-recom-sub2/S10P22A702.git'
            }
        }
        stage('docker build') {
            steps {
                echo 'build'
                
                // 실행 중인 컨테이너가 있는지 확인 후 삭제
                sh 'docker ps -a | grep fe && docker rm -f fe || true'

                // 프론트 도커파일 위치 설정 -> 도커 이미지로 빌드 -> 도커 컨테이너 안쪽에서 sh수행
                // fe라고 해놔서 nginx 호스트 이름을 fe로 하면 될듯
                
                withCredentials([file(credentialsId: '.env', variable: 'VITE_ENV')]) {
                // 'SECRET_KEY' 환경 변수를 사용하여 필요한 작업 수행
                sh 'cp $VITE_ENV dango-project/'
                }
                
                
                
                 // 도커 이미지 빌드
                script {
                    
                    docker.build('fe', '-f dango-project/Dockerfile dango-project')    
                }
                
                // 도커 컨테이너 실행
                sh 'docker run -e TZ=Asia/Seoul -d -p 3000:3000 --name fe --network dango fe'

            }
        }
        stage('deploy') {
            steps {
                echo 'deploy'   
            }
        }
    }
}
```

BE

```jsx
pipeline {
    agent any

    stages {
        stage('clone') {
            steps {
                echo 'Branch : be-dev'
                echo 'Clone repository'
                git branch: 'dev', url: 'https://lab.ssafy.com/s10-bigdata-recom-sub2/S10P22A702', credentialsId: 'hyang'
            }
        }

        stage('docker build') {
            steps {

                echo 'docker build start'
                // 실행 중인 컨테이너가 있는지 확인 후 삭제
                // 스프링 컨테이너는 be 라는 이름으로 돌리고 있다
                sh 'docker ps -a | grep be && docker rm -f be || true'

                echo 'killed prev container'

                withCredentials([file(credentialsId: 'application-secret.yml', variable: 'SECRET_KEY')]) {
                    // 'SECRET_KEY' 환경 변수를 사용하여 필요한 작업 수행
                    sh 'cp $SECRET_KEY backend/src/main/resources/'
                }
                dir('backend') {
                    sh 'chmod +x ./gradlew'
		            sh "./gradlew clean build --exclude-task test"
                }
                // 백엔드 도커파일 위치 설정 -> 도커 이미지로 빌드 -> 도커 컨테이너 안쪽에서 sh수행
                // 도커파일에서 빌드, 실행까지
                // 도커 이미지 빌드
                script {
                    docker.build('be', '-f backend/Dockerfile backend')
                }
                sh 'docker run -e TZ=Asia/Seoul -d -p 8081:8081 --name be --network dango be'
                
            }
        }
    }
}

```
